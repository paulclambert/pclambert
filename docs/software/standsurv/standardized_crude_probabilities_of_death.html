<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sarah Booth">

<title>Standardized Crude Probabilities of Death</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Paul Lambert</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../talks.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../courses.html"> 
<span class="menu-text">Courses</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../interactive_graphs.html"> 
<span class="menu-text">Interactive graphs</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#by-sarah-booth-sarah.boothle.ac.uk" id="toc-by-sarah-booth-sarah.boothle.ac.uk" class="nav-link active" data-scroll-target="#by-sarah-booth-sarah.boothle.ac.uk">By Sarah Booth (sarah.booth@le.ac.uk)</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a></li>
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods">Methods</a></li>
  <li><a href="#example-simulated-colon-cancer-data" id="toc-example-simulated-colon-cancer-data" class="nav-link" data-scroll-target="#example-simulated-colon-cancer-data">Example (simulated colon cancer data)</a>
  <ul class="collapse">
  <li><a href="#prepare-data" id="toc-prepare-data" class="nav-link" data-scroll-target="#prepare-data">Prepare data</a></li>
  <li><a href="#fitting-the-model" id="toc-fitting-the-model" class="nav-link" data-scroll-target="#fitting-the-model">Fitting the model</a></li>
  <li><a href="#marginal-crude-probabilities" id="toc-marginal-crude-probabilities" class="nav-link" data-scroll-target="#marginal-crude-probabilities">Marginal crude probabilities</a></li>
  <li><a href="#standardization-using-contrasts" id="toc-standardization-using-contrasts" class="nav-link" data-scroll-target="#standardization-using-contrasts">Standardization using contrasts</a></li>
  <li><a href="#specific-covariate-patterns" id="toc-specific-covariate-patterns" class="nav-link" data-scroll-target="#specific-covariate-patterns">Specific covariate patterns</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Standardized Crude Probabilities of Death</h1>
</div>



<div class="quarto-title-meta column-page-left">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sarah Booth </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="by-sarah-booth-sarah.boothle.ac.uk" class="level3">
<h3 class="anchored" data-anchor-id="by-sarah-booth-sarah.boothle.ac.uk">By Sarah Booth (sarah.booth@le.ac.uk)</h3>
<blockquote class="blockquote">
<p><a href="../..\downloads/code/crude_probabilities_of_death.do">Download Stata Do file here</a></p>
</blockquote>
<blockquote class="blockquote">
<p>You will need to install <code>standsurv</code> to run the example. <a href="../../software/standsurv.html">Details here</a></p>
</blockquote>
</section>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>The <a href="../../software/standsurv/standardized_relative_survival.html">standardized relative survival tutorial</a> introduced the concept of relative survival and illustrated how flexible parametric survival models can be fitted in this framework. Under certain conditions, relative survival can be interpreted as net survival, the survival in a hypothetical world where it is not possible to die from other causes. This measure is often used to make fair comparisons of cancer survival between different countries or populations as only the excess mortality related to the cancer diagnosis is analysed and differences in other cause mortality are ignored.</p>
<p>However, measures of survival in the “real world” can be more useful for clinical decision making as they consider the competing risk of dying from causes other than cancer. This tutorial demonstrates how <code>standsurv</code> can be used to estimate the probabilities of dying from cancer and other causes after flexible parametric survival models are fitted in the relative survival setting. In the relative survival framework, these are known as crude probabilities of death, whereas in a cause-specific setting, they are referred to as cause-specific cumulative incidence functions (CIF). Further details on how to calculate these measures in the cause-specific setting can be found <a href="../../software/standsurv/standardized_cif.html">here</a>.</p>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<p><span class="math inline">\(F_{cancer}(t|x_i)\)</span> denotes the probability of death due to cancer and can be calculated using the following equation where the relative survival function <span class="math inline">\(R(u|x_{1i})\)</span> and the excess hazard due to cancer <span class="math inline">\(\lambda(u|x_{1i})\)</span> can both be obtained from the relative survival model. <span class="math inline">\(S^*(u|x_{2i})\)</span> is the expected survival of a similar group of people in the general population without cancer and can be obtained from the population life tables (also known as a “popmort” file). The life tables used in this particular example correspond to the expected survival in England and are stratified by calendar year, age, sex and deprivation group.</p>
<p><span class="math inline">\(x_{1}\)</span> is a subset of <span class="math inline">\(x\)</span> and includes the covariates relating to the excess mortality such as age at diagnosis, sex, deprivation group and stage at diagnosis. <span class="math inline">\(x_{2}\)</span> is a different subset of <span class="math inline">\(x\)</span> and contains the factors that the life tables are stratified by, which in this particular example, are age, calendar year, sex and deprivation group.</p>
<p><span class="math display">\[
F_{cancer}(t|x_i) = \int_0^t S(u|x_i) \lambda(u|x_{1i}) du = \int_0^t S^*(u|x_{2i}) R(u|x_{1i}) \lambda(u|x_{1i}) du
\]</span></p>
<p><span class="math inline">\(F_{other}(t|x_i)\)</span> is the probability of dying from causes other than cancer, where <span class="math inline">\(h^*(t|x_{2i})\)</span> is the expected hazard function and can be obtained from the population life tables.</p>
<p><span class="math display">\[
F_{other}(t|x_i) = \int_0^t S(u|x_i) h^*(u|x_{2i}) du = \int_0^t S^*(u|x_{2i}) R(u|x_{1i}) h^*(u|x_{2i}) du
\]</span></p>
<p>The crude probabilities of death due to each cause sum to the all cause probability of death.</p>
<p><span class="math display">\[
F_{all cause}(t|x_i) = F_{cancer}(t|x_i) + F_{other}(t|x_i)
\]</span></p>
</section>
<section id="example-simulated-colon-cancer-data" class="level2">
<h2 class="anchored" data-anchor-id="example-simulated-colon-cancer-data">Example (simulated colon cancer data)</h2>
<section id="prepare-data" class="level3">
<h3 class="anchored" data-anchor-id="prepare-data">Prepare data</h3>
<p>This tutorial uses simulated data from a paper by <a href="https://onlinelibrary.wiley.com/doi/full/10.1002/bimj.201900355">Syriopoulou et al</a>. It is based on colon cancer survival in England and is restricted to only include the most and least deprived quintile of the population.</p>
<p>This dataset contains the following variables: ID number (<code>id</code>), age at diagnosis (<code>agediag</code>, 16-104), stage of tumour at diagnosis (<code>stage</code>, stages 1-4), year of diagnosis (<code>yeardiag</code>, 2011-2013), month of diagnosis (<code>diagmonth</code>), date of diagnosis (<code>datediag</code>), sex (<code>sex</code>, 0 = Male, 1 = Female), survival time in years (<code>t</code>, 0.0027 - 10), survival status (<code>dead</code>, 0 = Alive, 1 = Dead) and deprivation quintile (<code>dep</code>, 1 = Least deprived, 5 = Most Deprived).</p>
<p>As computation is slow I have taken a 20% sample of the original data, which leads to 3,061. individuals.</p>
<p>To prepare the data, I first format the date of diagnosis variable and restrict the analysis to individuals who were diagnosed with colon cancer between the ages of 18 and 99. I also need to recode the variable relating to sex as currently, 0 = Male and 1 = Female, whereas in the life tables (<code>popmort</code> file), 1 = Male and 2 = Female. Recoding this variable means that the life tables will be correctly merged in.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">set</span> <span class="dv">seed</span> 128763</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>. <span class="kw">use</span> https:<span class="co">//www.pclambert.net/data/colonsim_stage if runiform()&lt;0.2, clear</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>. <span class="co">// Format datediag to display as a date</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>. <span class="kw">format</span> datediag %td</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>. <span class="co">// Restrict analysis to patients aged 18-99 at diagnosis</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>. <span class="kw">keep</span> <span class="kw">if</span> agediag&gt;=18 &amp; agediag&lt;=99</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>(0 observations deleted)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>. <span class="co">// Recode the sex variable to match the popmort file</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>. <span class="kw">replace</span> sex = sex+1</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>(3,061 <span class="fu">real</span> changes made)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>. <span class="kw">label</span> <span class="kw">define</span> label_sex 1 <span class="st">"Male"</span> 2 <span class="st">"Female"</span> </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>. <span class="kw">label</span> <span class="kw">values</span> sex label_sex </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>. <span class="kw">gen</span> female = sex==2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>stset</code> can then be used to calculate the survival time of each of the 15,627 individuals and to censor any individuals who were still alive 5 years after their diagnosis.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">stset</span> t, failure(dead=1) id(id) <span class="kw">exit</span>(time 5)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>Survival-time <span class="kw">data</span> settings</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>           ID <span class="kw">variable</span>: id</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>         Failure event: dead==1</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>Observed time interval: (t[<span class="dt">_n</span>-1], t]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>     Exit <span class="kw">on</span> <span class="kw">or</span> before: time 5</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>--------------------------------------------------------------------------</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>      3,061  <span class="kw">total</span> observations</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>          0  exclusions</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>--------------------------------------------------------------------------</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>      3,061  observations remaining, representing</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>      3,061  subjects</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>      1,581  failures <span class="kw">in</span> single-failure-per-subject <span class="kw">data</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  9,926.831  <span class="kw">total</span> analysis time <span class="fu">at</span> risk and under observation</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                                                At risk from t =         0</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                                     Earliest observed entry t =         0</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>                                          Last observed <span class="kw">exit</span> t =         5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In order to fit a relative survival model, the expected mortality rate of each individual at their event time is required. To identify the correct expected mortality rates, I first calculate the attained age (age of the individual at their event time) and attained year (calendar year when the event or censoring occurs). I name these variables <code>age</code> and <code>year</code> to match the variable names in the life tables. As the maximum age included in the life tables is 100, I force the maximum attained age to be set as 100. Similarly, as the life tables only go up to 2016, I also make the maximum attained year to be 2016. This makes the assumption that the expected rates in 2018 for each combination of age, sex and deprivation group are the same as they were in 2016. The expected mortality rates can then be merged in by matching for attained age, attained year, sex and deprivation quintile.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>. <span class="co">// Attained age</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>. <span class="kw">gen</span> age = <span class="fu">min</span>(<span class="fu">floor</span>(agediag + _t),100)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>. <span class="co">// Attained calendar year</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>. <span class="kw">gen</span> <span class="fu">year</span> = <span class="fu">min</span>(<span class="fu">floor</span>(yeardiag + _t),2016)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>. <span class="co">// Merge in life tables</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>. <span class="kw">merge</span> <span class="fu">m</span>:1 age <span class="fu">year</span> dep sex <span class="kw">using</span> https:<span class="co">//www.pclambert.net/data/popmort_uk_2017, ///</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>&gt; <span class="kw">keep</span>(<span class="fu">match</span> master) keepusing(rate)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    Result                      Number <span class="kw">of</span> <span class="kw">obs</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    -----------------------------------------</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    Not matched                             0</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    Matched                             3,061  (<span class="dt">_merge</span>==3)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    -----------------------------------------</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>. <span class="kw">drop</span> age <span class="fu">year</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I drop the attained age (<code>age</code>) and attained year (<code>year</code>) variables now that the expected rates have been merged in.</p>
<p>Previously, when using <code>stpm2</code> various variables needed to be created. This included restricted cubic spline variables for the effect of age, dummy variables for stage and various interactions. For the spline variables, the knot positions and projection matrix for orthogonalization needed to be save. Using <code>stpm3</code> makes things much easier, as all these can be included in the commands itself.</p>
</section>
<section id="fitting-the-model" class="level3">
<h3 class="anchored" data-anchor-id="fitting-the-model">Fitting the model</h3>
<p>Now I fit the flexible parametric survival model used by <a href="https://onlinelibrary.wiley.com/doi/full/10.1002/bimj.201900355">Syriopoulou et al (2021)</a> that includes age at diagnosis (using natural splines), sex, deprivation group and stage at diagnosis as covariates, along with interaction terms between stage and deprivation group. It also includes time-dependent effects for the main effects of deprivation group, stage and age (using natural splines). It uses 5 degrees of freedom for the baseline and 3 degrees of freedom to model the time-dependent effects.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>. stpm3 i.female i.dep i.stage i.stage#dep @ns(agediag,df(3)), <span class="kw">scale</span>(lncumhazard) df(5) <span class="co">///</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>&gt;                tvc(i.dep i.stage @ns(agediag,df(3))) dftvc(3) bhazard(rate) vsquish</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>Iteration 0:  Log likelihood = -3104.5329  </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>Iteration 1:  Log likelihood =  -3019.487  </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>Iteration 2:  Log likelihood = -3008.7321  </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>Iteration 3:  Log likelihood = -3007.9984  </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>Iteration 4:  Log likelihood = -3007.8399  </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>Iteration 5:  Log likelihood = -3007.7991  </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>Iteration 6:  Log likelihood = -3007.7894  </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>Iteration 7:  Log likelihood = -3007.7867  </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>Iteration 8:  Log likelihood = -3007.7859  </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>Iteration 9:  Log likelihood = -3007.7857  </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>Iteration 10: Log likelihood = -3007.7856  </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>Iteration 11: Log likelihood = -3007.7856  </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>                                                        Number <span class="kw">of</span> <span class="kw">obs</span> =  3,061</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>                                                        Wald <span class="fu">chi2</span>(11) = 541.45</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>Log likelihood = -3007.7856                             Prob &gt; <span class="fu">chi2</span>   = 0.0000</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>----------------------------------------------------------------------------------------------</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                             | Coefficient  Std. err.      z    P&gt;|z|     [95% conf. interval]</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>-----------------------------+----------------------------------------------------------------</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="kw">xb</span>                           |</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>                    1.female |   .0258002   .0611239     0.42   0.673    -.0940004    .1456009</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>                       5.dep |   11.33406   610.7999     0.02   0.985    -1185.812     1208.48</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>                       stage |</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>                          2  |   11.77162   610.8012     0.02   0.985    -1185.377     1208.92</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>                          3  |   13.63744   610.8011     0.02   0.982    -1183.511    1210.786</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>                          4  |   14.87865   610.8011     0.02   0.981     -1182.27    1212.027</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>                   stage#dep |</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>                        2 5  |  -11.34975   610.7999    -0.02   0.985    -1208.496    1185.796</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>                        3 5  |  -11.19332   610.7999    -0.02   0.985    -1208.339    1185.952</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                        4 5  |  -11.26091   610.7999    -0.02   0.985    -1208.407    1185.885</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>             _ns_f1_agediag1 |   .8547894   1.699503     0.50   0.615    -2.476176    4.185755</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>             _ns_f1_agediag2 |  -1.255521   .6266172    -2.00   0.045    -2.483668   -.0273739</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>             _ns_f1_agediag3 |   .1428389   .6831001     0.21   0.834    -1.196013    1.481691</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>-----------------------------+----------------------------------------------------------------</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>time                         |</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>                        _ns1 |  -46.59876   30.73218    -1.52   0.129    -106.8327    13.63522</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>                        _ns2 |   18.43374   12.93551     1.43   0.154    -6.919398    43.78689</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>                        _ns3 |  -.1336661   1.018261    -0.13   0.896    -2.129421    1.862089</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>                        _ns4 |   .2966349   .6233048     0.48   0.634    -.9250201     1.51829</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>                        _ns5 |   .3442934   .4569246     0.75   0.451    -.5512623    1.239849</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>              dep#c._ns_tvc1 |</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>                          5  |   -1.05234   1.780841    -0.59   0.555    -4.542724    2.438045</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>              dep#c._ns_tvc2 |</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>                          5  |    1.22833    1.00034     1.23   0.219       -.7323    3.188959</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>              dep#c._ns_tvc3 |</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>                          5  |   .3265529   .1202818     2.71   0.007      .090805    .5623008</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>            stage#c._ns_tvc1 |</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>                          2  |   15.54094   31.12577     0.50   0.618    -45.46444    76.54632</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>                          3  |   20.29633   30.75615     0.66   0.509    -39.98462    80.57727</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>                          4  |   22.62941   30.67119     0.74   0.461    -37.48501    82.74383</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>            stage#c._ns_tvc2 |</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>                          2  |  -4.520576   15.57263    -0.29   0.772    -35.04238    26.00122</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>                          3  |  -9.567492    15.3728    -0.62   0.534    -39.69763    20.56265</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>                          4  |  -9.400435   15.31143    -0.61   0.539    -39.41028    20.60941</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>            stage#c._ns_tvc3 |</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>                          2  |  -.3308294   .7373107    -0.45   0.654    -1.775932    1.114273</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>                          3  |  -1.137763   .7047464    -1.61   0.106    -2.519041    .2435142</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>                          4  |   -.448099   .6956624    -0.64   0.519    -1.811572    .9153742</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>c._ns_f1_agediag1#c._ns_tvc1 |   20.12228   34.46616     0.58   0.559    -47.43015     87.6747</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>c._ns_f1_agediag1#c._ns_tvc2 |   -30.2422   19.20078    -1.58   0.115    -67.87503    7.390637</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>c._ns_f1_agediag1#c._ns_tvc3 |  -4.893479   2.803528    -1.75   0.081    -10.38829    .6013342</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>c._ns_f1_agediag2#c._ns_tvc1 |  -6.719063    18.2678    -0.37   0.713    -42.52329    29.08517</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>c._ns_f1_agediag2#c._ns_tvc2 |   7.470501   10.16327     0.74   0.462    -12.44915    27.39015</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>c._ns_f1_agediag2#c._ns_tvc3 |  -.0054526   1.219612    -0.00   0.996    -2.395848    2.384942</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>c._ns_f1_agediag3#c._ns_tvc1 |   9.465698   9.075787     1.04   0.297    -8.322518    27.25391</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>c._ns_f1_agediag3#c._ns_tvc2 |  -10.82306   5.100466    -2.12   0.034    -20.81979   -.8263326</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>c._ns_f1_agediag3#c._ns_tvc3 |  -1.067077   .9595113    -1.11   0.266    -2.947684    .8135306</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>                       <span class="dt">_cons</span> |  -14.02936   610.8006    -0.02   0.982    -1211.176    1183.118</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>----------------------------------------------------------------------------------------------</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>Extended functions</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a> (1) @ns(agediag, df(3))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="marginal-crude-probabilities" class="level3">
<h3 class="anchored" data-anchor-id="marginal-crude-probabilities">Marginal crude probabilities</h3>
<p>Now that the relative survival model is fitted, the crude probabilities of death can be estimated. The marginal crude probabilities of death are an average measure that can be used to summarise the mortality of the <span class="math inline">\(N\)</span> individuals used to develop the model. Each individual’s predicted probability of death from each cause is calculated at a particular time point and then averaged.</p>
<p><span class="math display">\[ \widehat{F}_{M,cancer}(t) = \frac{1}{N} \sum{i=1}^{N} {\widehat{F}_{cancer}(t|x_i)} \]</span></p>
<p><span class="math display">\[ \widehat{F}_{M,other}(t)  = \frac{1}{N} \sum{i=1}^{N} {\widehat{F}_{other}(t|x_i)} \]</span></p>
<p>In <code>standsurv</code> this can be achieved by specifying the <code>crudeprob</code> option. Including <code>at1(.)</code> means that the predictions for each individual will be made based on their observed covariate values in the dataset. Using the <code>timevar()</code> option means that the marginal crude probabilities will be calculated at a particular time point or a series of time points. Here <code>t5</code> allows these probabilities to be estimated at 51 time points so that a smooth curve across the 5 year follow-up period can be produced.</p>
<p>As this calculation requires the expected mortality rates, the population life tables need to be specified using <code>expsurv()</code> which links the age of the individuals in the dataset to their attained age and calendar year at each time point. As the population life tables are stratified by sex and deprivation these are specified using <code>pmother()</code>. As the maximum age in the life tables is 100 and the maximum year is 2016, I specify these options using <code>pmmaxage()</code> and <code>pmmaxyear()</code> respectively so that any values greater than these will be set to the maximum value. The <code>atvar()</code> option is used to name the variables where the predictions will be stored. By calling this “marg”, by default it will create a variable called <code>marg_disease</code> and another named <code>marg_other</code> to save the crude probabilities of death due to cancer and other causes respectively.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">range</span> t5 0 5 51</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>(3,010 <span class="fu">missing</span> <span class="kw">values</span> generated)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>. standsurv, crudeprob               <span class="co">///  Crude probabilities of death</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>&gt;            timevar(t5)             <span class="co">///  Time points used for predictions</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>&gt;            frame(f1, <span class="kw">replace</span>)      <span class="co">///  Frame to save results</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>&gt;            at1(.)                  <span class="co">///  Use observed covariate values            </span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>&gt;            atvar(marg)             <span class="co">///  New variable containing the predictions</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>&gt;            expsurv(<span class="kw">using</span>(https:<span class="co">//www.pclambert.net/data/popmort_uk_2017) ///  Popmort file</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>&gt;              agediag(agediag)      <span class="co">///  Age at diagnosis in the dataset</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>&gt;              datediag(datediag)    <span class="co">///  Date of diagnosis in the dataset</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>&gt;              pmage(age)            <span class="co">///  Age variable in the popmort file</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>&gt;              pmyear(<span class="fu">year</span>)          <span class="co">///  Year variable in the popmort file                     </span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>&gt;              pmother(dep sex)      <span class="co">///  Other variables included in the popmort file</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>&gt;              pmrate(rate)          <span class="co">///  Rate variable in the popmort file</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>&gt;              pmmaxage(100)         <span class="co">///  Maximum age in the popmort file</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>&gt;              pmmaxyear(2016)       <span class="co">///  Maximum year in the popmort file</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>&gt;              ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We now plot the results.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>. frame f1 {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>.   <span class="kw">twoway</span> (<span class="kw">line</span> marg_disease t5),               <span class="co">///</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">xtitle</span>(<span class="st">"Years since Diagnosis"</span>)       <span class="co">///</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">ytitle</span>(<span class="st">"Probability of Death"</span>)        <span class="co">///</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="kw">ylabel</span>(,<span class="kw">format</span>(%3.1f))                <span class="co">///</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">title</span>(<span class="st">"Cancer"</span>)                       <span class="co">/// </span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">name</span>(marg_disease,<span class="kw">replace</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>.   <span class="kw">twoway</span> (<span class="kw">line</span> marg_other t5, pstyle(p2line)), <span class="co">/// </span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">xtitle</span>(<span class="st">"Years since Diagnosis"</span>)       <span class="co">///</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">ytitle</span>(<span class="st">"Probability of Death"</span>)        <span class="co">///</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="kw">ylabel</span>(0(0.1)0.4,<span class="kw">format</span>(%3.1f))       <span class="co">///</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">title</span>(<span class="st">"Other Causes"</span>)                 <span class="co">///</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">name</span>(marg_other,<span class="kw">replace</span>) </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>. </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>. <span class="kw">graph</span> <span class="bn">combine</span> marg_disease marg_other</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>. }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="../..\statasvg/crudeprob_marg.svg" class="img-fluid"></p>
<p>Here we can see that within this group of people, the probability of dying from cancer is over 3 times larger than dying from other causes by 5 years after diagnosis. An alternative way to present these predictions is to produce a stacked graph by adding the crude probabilities of death from each cause together. The blue line then indicates the all-cause probability of death and each coloured region indicates the probability of being alive, dying from cancer and dying from other causes.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>. frame f1 {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>.   <span class="kw">gen</span> alive = 1</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>.   <span class="kw">gen</span> marg_all = marg_disease + marg_other</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>.   <span class="kw">twoway</span> (area alive t5, fintensity(30))           <span class="co">///</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>&gt;          (area marg_all t5, fintensity(30))        <span class="co">///</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>&gt;          (area marg_other t5,  fintensity(30)),    <span class="co">///</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">ytitle</span>(<span class="st">"Probability"</span>)                     <span class="co">///</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">xtitle</span>(<span class="st">"Time from diagnosis"</span>)             <span class="co">///</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="kw">ylabel</span>(,<span class="kw">format</span>(%3.1f))                    <span class="co">/// </span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">legend</span>(<span class="kw">order</span>(1 <span class="st">"Alive"</span>                    <span class="co">///</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>&gt;                       2 <span class="st">"Death from Cancer"</span>        <span class="co">///</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>&gt;                       3 <span class="st">"Death from Other Causes"</span>) <span class="co">///</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>&gt;                          <span class="bn">rows</span>(1) <span class="bn">ring</span>(1) pos(6)) </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>. }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="../..\statasvg/crudeprob_stacked_marg.svg" class="img-fluid"></p>
</section>
<section id="standardization-using-contrasts" class="level3">
<h3 class="anchored" data-anchor-id="standardization-using-contrasts">Standardization using contrasts</h3>
<p>The <code>contrast()</code> option can be used to investigate differences between subgroups in the population. As shown in the <a href="../../software/standsurv/standardized_relative_survival.html">standardized relative survival tutorial</a>, we might be interested in the effect of deprivation.</p>
<p>We cannot fairly compare these groups using their observed covariate values since this would mean we would be averaging over different covariate patterns within each deprivation group. For example, in the most deprived group there is a greater proportion of individuals diagnosed with Stage 4 tumours so we wouldn’t know whether the differences in the marginal crude probabilities of death were due to the effect of deprivation or other factors such as stage.</p>
<p>To account for this we can first make predictions for all individuals by supposing that they are all in the most deprived group (i.e.&nbsp;setting <code>dep5=1</code> for everyone regardless of their true deprivation group but keeping the observed values of all other covariates in the dataset). We can then make a second set of predictions where all individuals are assumed to be in the least deprived group (<code>dep5=0</code>). This is called standardization and further examples can be found in the <a href="../../software/standsurv/standardized_relative_survival.html">standardized relative survival tutorial</a>.</p>
<p>This approach allows us to investigate the differences in the marginal crude probabilities of death for this hypothetical population. Mathematically, it can be written as the following where <span class="math inline">\(Z\)</span> is the binary covariate <code>dep5</code> (<span class="math inline">\(Z=1\)</span> is the most deprived group and <span class="math inline">\(Z=0\)</span> is the least deprived group).</p>
<p><span class="math display">\[ \frac{1}{N}\sum_{i=1}^N{\widehat{F}_{cancer}(t|Z=1,x_i)} - \frac{1}{N}\sum_{i=1}^N{\widehat{F}_{cancer}(t|Z=0,x_i)} \]</span></p>
<p><span class="math display">\[ \frac{1}{N}\sum_{i=1}^N{\widehat{F}_{other}(t|Z=1,x_i)} - \frac{1}{N}\sum_{i=1}^N{\widehat{F}_{other}(t|Z=0,x_i)} \]</span></p>
<p>I specify this in <code>standsurv</code> using the <code>at1()</code> and <code>at2()</code> options to estimate the marginal predictions for the least and most deprived group respectively.</p>
<p>I also use the <code>at1()</code> and <code>at2()</code> within the <code>expsurv()</code> function to ensure that the correct expected mortality rates are used in each calculation. I then use the <code>contrast()</code> option to calculate the absolute difference in the marginal crude probabilities between the deprivation groups.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>. standsurv, crudeprob               <span class="co">///  Crude probabilities of death</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>&gt;            timevar(t5)             <span class="co">///  Time points used for predictions</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>&gt;            frame(f2, <span class="kw">replace</span>)      <span class="co">///  frame to save results to</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>&gt;            at1(dep 1)              <span class="co">///  Least deprived</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>&gt;            at2(dep 5)              <span class="co">///  Most deprived</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>&gt;            atvar(dep_1 dep_5)      <span class="co">///  New variables containing the predictions</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>&gt;            contrast(difference)    <span class="co">///  Calculate the difference between groups</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>&gt;            contrastvar(diff_dep)   <span class="co">///  New variables containing the difference </span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>&gt;            <span class="kw">ci</span>                      <span class="co">///  Calculate confidence intervals</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>&gt;            expsurv(<span class="kw">using</span>(https:<span class="co">//www.pclambert.net/data/popmort_uk_2017) ///  Popmort file</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>&gt;              agediag(agediag)      <span class="co">///  Age at diagnosis in the dataset</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>&gt;              datediag(datediag)    <span class="co">///  Date of diagnosis in the dataset</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>&gt;              pmage(age)            <span class="co">///  Age variable in the popmort file</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>&gt;              pmyear(<span class="fu">year</span>)          <span class="co">///  Year variable in the popmort file                    </span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>&gt;              pmother(dep sex)      <span class="co">///  Other variables included in the popmort file</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>&gt;              pmrate(rate)          <span class="co">///  Rate variable in the popmort file</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>&gt;              pmmaxage(100)         <span class="co">///  Maximum age in the popmort file</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>&gt;              pmmaxyear(2016)       <span class="co">///  Maximum year in the popmort file</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>&gt;              at1(dep 1)            <span class="co">///  Use expected rates for least deprived</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>&gt;              at2(dep 5)            <span class="co">///  Use expected rates for most deprived</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>&gt;              )  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can also plot the differences in the marginal probabilities.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>. frame f2 {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>.   <span class="kw">twoway</span> (rarea diff_dep_disease_lci diff_dep_disease_uci t5, col(%30)) <span class="co">///</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>&gt;          (<span class="kw">line</span> diff_dep_disease t5, pstyle(p1line)),                    <span class="co">///</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">legend</span>(<span class="kw">off</span>)                                                    <span class="co">///</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">xtitle</span>(<span class="st">"Years since Diagnosis"</span>)                                <span class="co">///</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">ytitle</span>(<span class="st">"Difference in Probability of Death"</span>)                   <span class="co">///</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="kw">ylabel</span>(0(0.01)0.1, <span class="kw">format</span>(%3.2f))                              <span class="co">///</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">title</span>(<span class="st">"Cancer"</span>)                                                <span class="co">///</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">name</span>(diff_cancer,<span class="kw">replace</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>.          </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>.   <span class="kw">twoway</span> (rarea diff_dep_other_lci diff_dep_other_uci t5, col(%30))     <span class="co">///</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>&gt;          (<span class="kw">line</span> diff_dep_other t5, pstyle(p1line)),                      <span class="co">///</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">legend</span>(<span class="kw">off</span>)                                                    <span class="co">///</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">xtitle</span>(<span class="st">"Years since Diagnosis"</span>)                                <span class="co">///</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">ytitle</span>(<span class="st">"Difference in Probability of Death"</span>)                   <span class="co">///</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="kw">ylabel</span>(0(0.01)0.1, <span class="kw">format</span>(%3.2f))                              <span class="co">///</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">title</span>(<span class="st">"Other Causes"</span>)                                          <span class="co">///</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">name</span>(diff_other,<span class="kw">replace</span>)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>. </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>.   <span class="kw">graph</span> <span class="bn">combine</span> diff_cancer diff_other, <span class="bn">ycommon</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>. }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="../..\statasvg/crudeprob_deprivation.svg" class="img-fluid"></p>
<p>Here we can see that the probability of death due to cancer and the probability of death due to other causes are both greater for the most deprived group.</p>
<p><img src="../..\statasvg/crudeprob_deprivation_contrast.svg" class="img-fluid"></p>
</section>
<section id="specific-covariate-patterns" class="level3">
<h3 class="anchored" data-anchor-id="specific-covariate-patterns">Specific covariate patterns</h3>
<p>Although using marginal measures can be useful to summarise the mortality of a group of individuals, we may instead be interested in more personalised predictions for an individual with a particular covariate pattern.</p>
<p>If we are interested in making predictions for a particular individual in the dataset we could do this by using the <code>predict</code> command and specify the values of the covariates we want to <code>predict</code> for.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">predict</span> CPc, crudeprob                <span class="co">///  Crude probabilities of death</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>&gt;         timevar(0 5,step(0.1))        <span class="co">///  Time points used for predictions</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>&gt;         frame(CP, <span class="kw">replace</span>)            <span class="co">/// frame to save predictions</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>&gt;         at1(agediag 85 stage 2 female 0 dep 1) <span class="co">/// covariate values </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>&gt;         expsurv(<span class="kw">using</span>(https:<span class="co">//www.pclambert.net/data/popmort_uk_2017) ///  Popmort file</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>&gt;                 agediag(85)           <span class="co">///  Age at diagnosis in the dataset</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>&gt;                 datediag(2011-1-1)    <span class="co">///  Date of diagnosis in the dataset</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>&gt;                 pmage(age)            <span class="co">///  Age variable in the popmort file</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>&gt;                 pmyear(<span class="fu">year</span>)          <span class="co">///  Year variable in the popmort file                       </span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>&gt;                 pmother(dep sex)      <span class="co">///  Other variables included in the popmort file</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>&gt;                 pmrate(rate)          <span class="co">///  Rate variable in the popmort file</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>&gt;                 pmmaxage(100)         <span class="co">///  Maximum age in the popmort file</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>&gt;                 pmmaxyear(2016)       <span class="co">///  Maximum year in the popmort file</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>&gt;                 expvar(CPo)           <span class="co">///</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>&gt;                 at1(dep 1 sex 2)      <span class="co">///</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>&gt;         )             </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>Predictions are stored <span class="kw">in</span> frame - CP</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>. </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>. frame CP {     </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>.   <span class="kw">gen</span> allcause = CPc + CPo</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>.   <span class="kw">gen</span> alive = 1</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>. </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>.   <span class="kw">twoway</span> (area alive tt, col(%30))                                              <span class="co">///</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>&gt;          (area allcause tt,   col(%30))                                         <span class="co">///</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>&gt;          (area CPo tt, col(%30)),                                               <span class="co">///</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">xtitle</span>(<span class="st">"Years since Diagnosis"</span>)                                        <span class="co">///</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">ytitle</span>(<span class="st">"Probability"</span>)                                                  <span class="co">///</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">title</span>(<span class="st">"Male, Stage 2, Deprivation Group 1, Diagnosed Aged 85 in 2011"</span>, <span class="co">///</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>&gt;                 <span class="kw">size</span>(*0.8))                                                     <span class="co">///</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="kw">ylabel</span>(,<span class="kw">format</span>(%3.1f))                                                 <span class="co">///</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>&gt;          <span class="bn">legend</span>(<span class="kw">order</span>(1 <span class="st">"Alive"</span>                                                 <span class="co">///</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>&gt;                       2 <span class="st">"Death from Cancer"</span>                                     <span class="co">///</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>&gt;                       3 <span class="st">"Death from Other Causes"</span>)                              <span class="co">///</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>&gt;                       <span class="bn">rows</span>(1) <span class="bn">ring</span>(1) pos(6)) </span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>.     </span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>. }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="../..\statasvg/crudeprob_stacked_id2510.svg" class="img-fluid"></p>
<section id="effect-of-age-at-diagnosis" class="level4">
<h4 class="anchored" data-anchor-id="effect-of-age-at-diagnosis">Effect of age at diagnosis</h4>
<p>I now show how you can calculate the crude probabilities of death for individuals with a particular covariate pattern which may not exist in the dataset. Here I make predictions for the following covariate pattern: male, from the least deprived group, diagnosed on 1st January 2011 with a stage 2 tumour and aged either 60, 70, 80 or 90.</p>
<p>This is done in a loop. It could be done with 4 separate <code>at</code> options, but a loop may be preferable with many predictions. Note that I use the <code>mergecreate</code> as a suboption of the <code>frame</code> option. This creates the frame if it does not exist, and otherwise merges with the existing frame.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">foreach</span> age <span class="kw">in</span> 60 70 80 90 {             </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  2.   <span class="kw">predict</span> CPc<span class="ot">`age'</span>,  crudeprob       <span class="co">///  Crude probabilities of death</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>&gt;           at1(agediag <span class="ot">`age'</span> female 0 dep 1 stage 2) <span class="co">///  Specify covariate pattern</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>&gt;           frame(CP_age, mergecreate) <span class="co">/// frame to save results</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>&gt;           timevar(0 5, step(0.1))    <span class="co">///  Time points used for predictions</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>&gt;           expsurv(<span class="kw">using</span>(https:<span class="co">//www.pclambert.net/data/popmort_uk_2017) /// Popmort file</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>&gt;             agediag(<span class="ot">`age'</span>)          <span class="co">///  Age at diagnosis variable</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>&gt;             datediag(2011-1-1)      <span class="co">///  Temporary date of diagnosis variable</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>&gt;             pmage(age)              <span class="co">///  Age variable in the popmort file</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>&gt;             pmyear(<span class="fu">year</span>)            <span class="co">///  Year variable in the popmort file</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>&gt;             pmother(dep sex)        <span class="co">///  Other variables included in the popmort file</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>&gt;             pmrate(rate)            <span class="co">///  Rate variable in the popmort file</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>&gt;             pmmaxage(100)           <span class="co">///  Maximum age in the popmort file</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>&gt;             pmmaxyear(2016)         <span class="co">///  Maximum year in the popmort file</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>&gt;             at1(dep 1 sex 1)        <span class="co">///  Use expected rates for least deprived and male</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>&gt;             expvar(CPo<span class="ot">`age'</span>)        <span class="co">///  crude probability (other causes)</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>&gt;           ) </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  3. }</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>Predictions are stored <span class="kw">in</span> frame - CP_age</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>Predictions are stored <span class="kw">in</span> frame - CP_age</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>Predictions are stored <span class="kw">in</span> frame - CP_age</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>Predictions are stored <span class="kw">in</span> frame - CP_age</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A panel plot can be produced using a loop over the 4 selected ages.</p>
<p>// All-cause probability of death</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>. frame CP_age: <span class="kw">gen</span> alive = 1</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>. frame CP_age {    </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>.   <span class="kw">foreach</span> age <span class="kw">in</span> 60 70 80 90 {           </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  2.     <span class="kw">gen</span> allcause<span class="ot">`age'</span> = CPc<span class="ot">`age'</span> + CPo<span class="ot">`age'</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  3.     <span class="kw">twoway</span> (area alive tt, col(%30))                    <span class="co">///</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>&gt;            (area allcause<span class="ot">`age'</span> tt, <span class="kw">color</span>(%30))          <span class="co">///</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>&gt;            (area CPo<span class="ot">`age'</span> tt, <span class="kw">color</span>(%30)),              <span class="co">///</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>&gt;            <span class="kw">ylabel</span>(,<span class="kw">format</span>(%3.1f))                       <span class="co">///</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>&gt;            <span class="bn">legend</span>(<span class="kw">order</span>(1 <span class="st">"Alive"</span>                       <span class="co">///</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>&gt;                         2 <span class="st">"Death from Cancer"</span>           <span class="co">///</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>&gt;                         3 <span class="st">"Death from Other Causes"</span>)    <span class="co">///</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>&gt;                         <span class="bn">rows</span>(1) <span class="bn">ring</span>(1) pos(6))         <span class="co">///</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>&gt;                         <span class="bn">xtitle</span>(<span class="st">"Years since Diagnosis"</span>) <span class="co">///</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>&gt;                         <span class="bn">ytitle</span>(<span class="st">"Probability"</span>)           <span class="co">///</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>&gt;                         <span class="bn">title</span>(<span class="st">"Age `age'"</span>)              <span class="co">///</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>&gt;            <span class="bn">name</span>(age<span class="ot">`age'</span>,<span class="kw">replace</span>) </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  4.   }</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>. }</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>. grc1leg age60 age70 age80 age90, <span class="bn">title</span>(<span class="st">"Male, Stage 2, Deprivation Group 1, Diagnosed in 2011"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="../..\statasvg/crudeprob_stacked_age.svg" class="img-fluid"></p>
<p>Here we see that age at diagnosis has a large impact on the all-cause probability of death. These graphs also show how the all-cause probability of death breaks down into the probability of dying from each cause. For example, a 90 year old with this covariate pattern is much more likely to die from other causes than their cancer. Understanding the most likely cause of death is important as this can help with making treatment decisions.</p>
</section>
<section id="effect-of-stage-at-diagnosis" class="level4">
<h4 class="anchored" data-anchor-id="effect-of-stage-at-diagnosis">Effect of stage at diagnosis</h4>
<p>Now we look at the effect of stage at diagnosis on the risk predictions of a woman diagnosed aged 75 on 1st January 2011 from the most deprived group. We could also loop over stage here, but I will use 4 <code>at</code> options as an alternative to predictions for selected ages above.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">predict</span> CPc1 CPc2 CPc3 CPc4, crudeprob frame(CP_stage, <span class="kw">replace</span>)   <span class="co">///</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>&gt;              at1(agediag 75 female 1 dep 5 stage 1)  <span class="co">///  Stage 1</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>&gt;              at2(agediag 75 female 1 dep 5 stage 2)  <span class="co">///  Stage 1</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>&gt;              at3(agediag 75 female 1 dep 5 stage 3)  <span class="co">///  Stage 1</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>&gt;              at4(agediag 75 female 1 dep 5 stage 4)  <span class="co">///  Stage 1</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>&gt;              timevar(0 5, step(0.1))             <span class="co">///  Time points</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>&gt;              expsurv(<span class="kw">using</span>(https:<span class="co">//www.pclambert.net/data/popmort_uk_2017) ///  Popmort file</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>&gt;              agediag(75)                         <span class="co">///  </span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>&gt;              datediag(2011-1-1)                 <span class="co">///  </span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>&gt;              pmage(age)                          <span class="co">///  Age variable in the popmort file</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>&gt;              pmyear(<span class="fu">year</span>)                        <span class="co">///  Year variable in the popmort file                    </span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>&gt;              pmother(dep sex)                    <span class="co">///  Other variables in the popmort file</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>&gt;              pmrate(rate)                        <span class="co">///  Rate variable in the popmort file</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>&gt;              pmmaxage(100)                       <span class="co">///  Maximum age in the popmort file</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>&gt;              pmmaxyear(2016)                     <span class="co">///  Maximum year in the popmort file</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>&gt;              at1(dep 5 sex 2)                    <span class="co">///  Use expected rates </span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>&gt;              at2(dep 5 sex 2)                    <span class="co">///  Use expected rates </span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>&gt;              at3(dep 5 sex 2)                    <span class="co">///  Use expected rates </span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>&gt;              at4(dep 5 sex 2)                    <span class="co">///  Use expected rates </span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>&gt;              expvar(CPo1 CPo2 CPo3 CPo4)         <span class="co">/// crud probs (other causes)</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>&gt;              ) </span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>Predictions are stored <span class="kw">in</span> frame - CP_stage</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>. frame CP_stage: <span class="kw">gen</span> alive = 1</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>. frame CP_stage {</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>.   <span class="kw">forvalues</span> stage = 1/4 {</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  2.     <span class="kw">gen</span> allcause<span class="ot">`stage'</span> = CPc<span class="ot">`stage'</span> + CPo<span class="ot">`stage'</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  3.     <span class="kw">twoway</span> (area alive tt, <span class="kw">color</span>(%30))               <span class="co">///</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>&gt;            (area allcause<span class="ot">`stage'</span> tt, <span class="kw">color</span>(%30))   <span class="co">///</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>&gt;            (area CPo<span class="ot">`stage'</span> tt, <span class="kw">color</span>(%30)), <span class="co">///</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>&gt;             <span class="kw">ylabel</span>(,<span class="kw">format</span>(%3.1f))                   <span class="co">///</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>&gt;             <span class="bn">legend</span>(<span class="kw">order</span>(1 <span class="st">"Alive"</span>                   <span class="co">///</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>&gt;                          2 <span class="st">"Death from Cancer"</span>         <span class="co">///</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>&gt;                          3 <span class="st">"Death from Other Causes"</span>) <span class="co">///</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>&gt;                          <span class="bn">rows</span>(1) <span class="bn">ring</span>(1) pos(6))       <span class="co">///</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>&gt;                          <span class="bn">xtitle</span>(<span class="st">"Years since Diagnosis"</span>) <span class="co">///</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>&gt;                          <span class="bn">ytitle</span>(<span class="st">"Probability"</span>) <span class="co">///</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>&gt;                          <span class="bn">title</span>(<span class="st">"Stage `stage'"</span>) <span class="co">///</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>&gt;                          <span class="bn">name</span>(stage<span class="ot">`stage'</span>,<span class="kw">replace</span>)     </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  4.   }</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>. }</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>. grc1leg stage1 stage2 stage3 stage4, <span class="bn">title</span>(<span class="st">"Female, Age 75, Deprivation Group 5, Diagnosed in 2011"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="../..\statasvg/crudeprob_stacked_stage.svg" class="img-fluid"></p>
<p>Here we can see that if an individual with this covariate pattern is diagnosed with an early stage tumour, the all-cause probability of death is very low and mostly due to other causes. In contrast, for an individual diagnosed with advanced stage cancer, the all-cause probability of death by 5 years is very high and cancer is the most likely cause of death.</p>
</section>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>Syriopoulou, E.; Rutherford, M. J. &amp; Lambert P. C. Understanding disparities in cancer prognosis: An extension of mediation analysis to the relative survival framework. <em>Biometrical Journal</em> 2021; <strong>63</strong>(2): 341-353</p>
<p>Lambert, P. C.; Dickman, P. W.; Nelson, C. P.; Royston P. Estimating the crude probability of death due to cancer and other causes using relative survival models. <em>Statistics in Medicine</em> 2010; <strong>29</strong>(7-8): 885-895</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>